# Moqui On Docker

This directory contains everything needed to deploy moqui on docker.

## Prerequisites

- Docker.
- Docker Compose Plugin.
- Java 21.
- Convenience scripts require bash.

## Deployment Instructions

To deploy moqui on docker with all necessary services, follow below:

- Choose a docker compose file in `docker/`. For example to deploy moqui on
  postgres you can choose moqui-postgres-compose.yml.
- Find and download a suitable JDBC driver for the target database, download its
  jar file and place it in `runtime/lib`.
- Generate moqui war file `./gradlew build`
- Get into docker folder `cd docker`
- Build chosen compose file, e.g. `./build-compose-up.sh moqui-postgres-compose.yml`

This last step would build the "moqui" image and deploy all services. You can
confirm by accessing the system on http://localhost

For a more secure and complete deployment, it is recommended to carefully review
the compose files and adjust as needed, including changing credentials and other
settings such as setting the host names, configuring for letsencrypt, etc ...

## Compose Files

There are multiple compose files offered providing different services:

- moqui-acme-postgres.yml: Moqui with nginx and automatically issues SSL
  certificates from letsencrypt. Requires configuring variables including
  `VIRTUAL_HOST` and `LETSENCRYPT_HOST` and mysql driver.
- moqui-cluster1-compose.yml: Moqui with mysql. Designed to be deployed in a
  hazelcast cluster for horizontal scaling. Requires preparing moqui with
  the hazelcast component and mysql driver.
- moqui-mysql-compose.yml: Moqui with mysql and nginx standard deployment.
- moqui-postgres-compose.yml: Moqui with postgres and nginx standard deployment.
- mysql-compose.yml: deploys all services with mysql except moqui itself. Useful
  when deploying moqui elsewhere like on a servlet container.
- postgres-compose.yml: Same as mysql-compose but replacing mysql with postgres

## Helper Scripts

- `build-compose-up.sh`: Given a certain compose file, build "moqui" and deploy
  all services in the chosen yml file.
- `clean.sh`: Clean the artifacts generated upon deployment including the
  database, opensearch and runtime.
- `compose-down.sh`: Tear down all services of a certain yml file
- `compose-up.sh`: Deploy all services of a certain yml file. If the "moqui"
  image exists in the yml file and it is not built, this script will fail, and
  you should use the build-compose-up.sh instead.
- `postgres_backup.sh`: Convenience script to create a database dump. Might need
  adjusting the credentials.

## Moqui Image

The actual image "moqui" is generated from the Dockerfile found in
`docker/simple/Dockerfile`. All compose files depend on a "moqui" image
generated by this file.
